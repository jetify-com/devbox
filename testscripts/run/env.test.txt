# Tests related to setting the environment for devbox run.

# Random vars should not leak into the run environment
env FOO=bar
exec devbox run echo '$FOO'
! stdout 'bar'

# Some vars (like HOME) should leak into the run environment
env HOME=/home/test
env USER=test-user
exec devbox run echo '$HOME'
stdout '/home/test'
exec devbox run echo '$USER'
stdout 'test-user'

# Fixed/hard-coded vars are set
exec devbox run echo '$NIX_PKGS_ALLOW_UNFREE'
stdout '1'
exec devbox run echo '$__ETC_PROFILE_NIX_SOURCED'
stdout '1'

# DEVBOX_* vars are passed through
env DEVBOX_FOO=baz
exec devbox run echo '$DEVBOX_FOO'
stdout 'baz'

# Vars defined in devbox.json are passed through
env DEVBOX_FEATURE_ENV_CONFIG=1
exec devbox run echo '$CONFIG_VAR1'
stdout 'abc'

# Vars defined in devbox.json that reference another variable are set
env DEVBOX_FEATURE_ENV_CONFIG=1
env DEVBOX_FOO=baz
exec devbox run echo '$CONFIG_VAR2'
stdout 'baz'

# TODO: test order/overwriting of variables

-- devbox.json --
{
  "packages": [],
  "env": {
    "CONFIG_VAR1": "abc",
    "CONFIG_VAR2": "$DEVBOX_FOO"
  }
}